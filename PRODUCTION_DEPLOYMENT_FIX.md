# Production Deployment Fix for `/api/save-temp-image`

## ğŸ” Problem Identified

The `/api/save-temp-image` endpoint was failing in production because:

1. **`setupProxy.js` only works in development**: The `setupProxy.js` file is only used by `react-scripts start` during development. In production, when you build the React app with `npm run build`, it creates static files that don't include any server-side code.

2. **No production server**: The built React app is just static HTML/CSS/JS files. There's no server running to handle API endpoints like `/api/save-temp-image`.

3. **Path resolution issues**: Even if a server existed, the path resolution using `__dirname` would be incorrect in production.

## âœ… Solution Implemented

### 1. Created Production Server (`server.js`)

A new Express server that:
- Serves the built React app from the `build` directory
- Handles all API routes from `setupProxy.js` (including `/api/save-temp-image`)
- Serves temp images from `public/temp` directory
- Works in both development and production environments

### 2. Fixed Path Resolution

Updated `setupProxy.js` to correctly resolve paths in both:
- **Development**: When `__dirname` is in `src/` folder
- **Production**: When `__dirname` is in the root folder (where `server.js` runs)

### 3. Updated Package.json

- Added `express` as a dependency
- Added `serve` script to run the production server

## ğŸš€ Deployment Steps

### For Local Testing:

1. **Build the React app:**
   ```bash
   npm run build
   ```

2. **Install Express (if not already installed):**
   ```bash
   npm install express
   ```

3. **Run the production server:**
   ```bash
   npm run serve
   ```

   The server will start on port 3000 (or the port specified in `PORT` environment variable).

### For Production Deployment (Azure/AWS/etc.):

1. **Build the app:**
   ```bash
   npm run build
   ```

2. **Ensure Express is installed:**
   ```bash
   npm install --production
   ```

3. **Update your deployment configuration:**

   **For Azure App Service:**
   - Set the startup command to: `node server.js`
   - Or create a `web.config` file with:
     ```xml
     <configuration>
       <system.webServer>
         <handlers>
           <add name="iisnode" path="server.js" verb="*" modules="iisnode"/>
         </handlers>
         <rewrite>
           <rules>
             <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
               <match url="^server.js\/debug[\/]?" />
             </rule>
             <rule name="StaticContent">
               <action type="Rewrite" url="public{REQUEST_URI}"/>
             </rule>
             <rule name="DynamicContent">
               <conditions>
                 <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
               </conditions>
               <action type="Rewrite" url="server.js"/>
             </rule>
           </rules>
         </rewrite>
       </system.webServer>
     </configuration>
     ```

   **For AWS/Heroku/Other platforms:**
   - Set the start command to: `node server.js`
   - Ensure the `PORT` environment variable is set (most platforms set this automatically)

4. **Ensure the `public/temp` directory exists and is writable:**
   - The server will create it automatically, but ensure the deployment environment has write permissions

## ğŸ“ File Structure

```
reel-reports-frontend/
â”œâ”€â”€ server.js              # NEW: Production server
â”œâ”€â”€ src/
â”‚   â””â”€â”€ setupProxy.js      # UPDATED: Fixed path resolution
â”œâ”€â”€ public/
â”‚   â””â”€â”€ temp/
â”‚       â””â”€â”€ edited-images/ # Temp image storage
â”œâ”€â”€ build/                 # Generated by npm run build
â””â”€â”€ package.json           # UPDATED: Added express and serve script
```

## ğŸ”§ How It Works

1. **Development Mode** (`npm start`):
   - Uses `react-scripts start` which automatically uses `setupProxy.js`
   - Works as before, no changes needed

2. **Production Mode** (`npm run serve`):
   - Express server serves the built React app
   - API routes from `setupProxy.js` are registered on the Express app
   - All `/api/*` endpoints work correctly
   - Static files are served from `build/` directory
   - Temp images are served from `public/temp/` directory

## âœ… Verification

After deployment, test the endpoint:

```bash
curl -X POST https://app.reelreports.ai/api/save-temp-image \
  -F "image=@test-image.png" \
  -F "fileName=test.png" \
  -F "sceneNumber=1" \
  -F "imageIndex=0"
```

Expected response:
```json
{
  "success": true,
  "message": "Image saved successfully",
  "path": "/temp/edited-images/test.png",
  "fileName": "test.png",
  ...
}
```

## ğŸ› Troubleshooting

### Issue: "Cannot find module 'express'"
**Solution:** Run `npm install express`

### Issue: "Port already in use"
**Solution:** Set a different port: `PORT=3001 npm run serve`

### Issue: "Cannot write to temp directory"
**Solution:** 
- Check file permissions on the server
- Ensure the `public/temp` directory exists and is writable
- Check server logs for detailed error messages

### Issue: "404 on /api/save-temp-image"
**Solution:**
- Ensure `server.js` is running (not just the static files)
- Check that the API routes are registered before the catch-all route
- Verify the deployment is using `node server.js` as the start command

## ğŸ“ Notes

- The `public/temp/` directory should be excluded from git (already in `.gitignore`)
- Consider implementing cleanup for old temp images
- The server uses port 3000 by default, but respects the `PORT` environment variable
- All API endpoints from `setupProxy.js` will work in production now

